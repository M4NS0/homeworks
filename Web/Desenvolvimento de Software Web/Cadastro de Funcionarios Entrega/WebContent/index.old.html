<!doctype html>
<html lang="en">

<head>

<title>Cadastro</title>

<!-- Required meta tags -->
<meta charset="utf-8">
<meta name="viewport"	content="width=device-width, initial-scale=1, shrink-to-fit=no">


<link href="css/bootstrap.min.css" rel="stylesheet">
<link href="css/index.css" rel="stylesheet">



<style>
body {
	background: white;
}

.alinhar {
	text-align: center;
}
</style>
</head>

<body>

	<div id="mensagem" class="alinhar"></div>
	<div id="divTabela" class="alinhar"></div>

	<div id="divForm" class="alinhar"></div>

	<div class="modal fade" id="modalMensagem">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h4 class="modal-title">Aviso</h4>
					<button type="button" class="close" data-dismiss="modal">
						<span>x</span>
					</button>
				</div>
				<div class="modal-body">
					<div id="msgModal"></div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-danger" data-dismiss="modal">Fechar</button>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="modalConfirma">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h4 class="modal-title">Confirmação</h4>
					<button type="button" class="close" data-dismiss="modal">
						<span>x</span>
					</button>
				</div>
				<div class="modal-body">Confirma exclusão?</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-danger" id="btn-fechar"
						data-dismiss="modal">Fechar</button>
					<button type="button" class="btn btn-success" id="btn-confirmar"
						data-dismiss="modal">Confirmar</button>
				</div>
			</div>
		</div>
	</div>

	  <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>

	<script>
		function excluir(msg) {
			$.excluir(msg);
		};

		function editar(msg) {
			$.mostraForm();
			$.popularForm(msg);
		};

		function novo() {
			$.mostraForm();
		};

		function salvar() {
			$.salvar();
		};

		function preparaForm() {
			return ('<b> Cadastro de Funcionários <b>\n' +
				'        <div class=\"form-group\">\n' +
				'            <strong>CPF</strong> <input class=\"form-control\" style=\"text-align: center;\" id=\"cpf\" name=\"cpf\" maxlength=\"11\">\n' +
				'        </div>\n' +
				'        <div class=\"form-group\">\n' +
				'            <strong>Nome</strong> <input class=\"form-control\" style=\"text-align: center;\" id=\"nome\" name=\"nome\">\n' +
				'        </div>\n' +
				'        <div class=\"form-group\">\n' +
				'            <strong>Nascimento</strong> <input class=\"form-control\" style=\"text-align: center;\" id=\"nascimento\" type=\"text\" name=\"nascimento\" maxlength=\"10\">\n' +
				'        </div>\n' +
				'        <div class=\"form-group\">\n' +
				'            <strong>Salário</strong> <input class=\"form-control\" style=\"text-align: center;\" id=\"salario\" type=\"text\" name=\"salario\">\n' +
				'        </div>\n' +
				'        <div class=\"row\">\n' +
				'            <div class=\"col-sm-6\">\n' +
				'                <label for=\"departamento\">Departamento: </label>\n' +
				'            </div>\n' +
				'            <div class=\"col-sm-6\">\n' +
				'                <select id=\"departamento\" name=\"departamento\">\n' +
				'                    <option value=\"\">Selecione</option>\n' +
				'                    <option value=\"Diretoria\">Diretoria</option>\n' +
				'                    <option value=\"Administrativo\">Administrativo</option>\n' +
				'                    <option value=\"TI\">Tecnologia da Informação</option>\n' +
				'                    <option value=\"Financeiro\">Financeiro</option>\n' +
				'                </select>\n' +
				'            </div>\n' +
				'        </div>\n' +
				'        <div class=\"row\">\n' +
				'            <div class=\"col-sm-6\">\n' +
				'                <label for=\"cargo\">Cargo: </label>\n' +
				'            </div>\n' +
				'            <div class=\"col-sm-6\">\n' +
				'                <select id=\"cargo\" name=\"cargo\">\n' +
				'                    <option value=\"\">Selecione</option>\n' +
				'                    <option value=\"Diretor\">Diretor</option>\n' +
				'                    <option value=\"Assistente\">Assistente</option>\n' +
				'                    <option value=\"Auxiliar\">Auxiliar</option>\n' +
				'                    <option value=\"Estagiario\">Estagiário</option>\n' +
				'                </select>\n' +
				'            </div>\n' +
				'        </div>\n' +
				'				\n' +
				'        <div class=\"container-fluid\">\n' +
				'            <div class=\"row\">\n' +
				'                <div class=\"col-sm-6\">\n' +
				'                    <button type=\"submit\" value=\"salvar\" name=\"salvar\"\n' +
				'                        class=\"btn btn-success btn-lg\">Salvar</button>\n' +
				'                </div>\n' +
				'                <div class=\"col-sm-6\">\n' +
				'                    <button type=\"reset\" value=\"reset\" name=\"limpar\"\n' +
				'                        class=\"btn btn-danger btn-lg\">Limpar</button>\n' +
				'                </div>\n' +
				'            </div>\n' +
				'        </div>\n' 
			);
		};


		function mostrarCabTabela() {
			return (
				'<table class="table table-striped-primary table hover">' +
				'<thead>' +
				'<tr>' +
				'<th style="text-align": center" scope="col">Cpf</th>' +
				'<th style="text-align": center" scope="col">Nome</th>' +
				'<th style="text-align": center" scope="col">Nascimento</th>' +
				'<th style="text-align": center" scope="col">Salário</th>' +
				'<th style="text-align": center" scope="col">Departamento</th>' +
				'<th style="text-align": center" scope="col">Cargo</th>' +
				'<th style="text-align": center" scope="col">Editar</th>' +
				'<th style="text-align": center" scope="col">Excluir</th>' +
				'</tr>' +
				'<thead>'
			);
		};

		function mostrarLinhaTabela(data) {
			return (
				'<tr><td style="text-align: center">' + data.cpf + '</td>' +
				'<td style="text-align": center">' + data.nome + '</td>' +
				'<td style="text-align": center">' + data.nascimento + '</td>' +
				'<td style="text-align": center">' + data.salario + '</td>' +
				'<td style="text-align": center">' + data.departamento + '</td>' +
				'<td style="text-align": center">' + data.cargo + '</td>' +
				'<td style="text-align": center"><button class="btn btn success" id="btnEditar" onclick="editar(' + data.cpf + ')">Editar</button></td>' +
				'<td style="text-align": center"><button class="btn btn danger" id="btnExcluir" onclick="$.excluir(' + data.cpf + ')">Excluir</button></td></tr>'
			);
		};

		function carregaTabela() {
			$.ajax({
				url: "http://localhost:8282/cadastro/ServletAll",
				type: 'get',
				data: {},
				beforeSend: function () {
					$("#mensagem").html("Analisando dados...");
				},
				success: function (msg) {

					let table = mostrarCabTabela() + '<tbody>';

					for (let i = 0; i < msg.length; i++) {

						table += mostraLinhaTabela(msg[i]);
					}
					table += '</tbody<table>';
					table += '</br><button class="btn btn-primary" onclick="novo()">Novo</button>';
					$('#divTabela').html(table);
					$('#mensagem').html('');
					$('#divForm').html('');
					if (msg.length == 0)
						$.mostraMensagem("Nenhum funcionário cadastrado");
				},
				error: function (msg) {
					$("#mensagem").html("");
					$.mostraMensagem("erro");
				}
			});
		};

		$(document).ready(function () {
			carregaTabela();

			$.excluir = function (cpf) {

				$("#modalConfirma").modal();
				$("#btn-confirmar").click(function () {

					$.ajax({

						url: "http://localhost:8282/cadastro/ServletExcluirFuncionario",
						type: 'get',
						data: {
							id: cpf
						},
						beforeSend: function () {
							$("#mensagem").text("Analisando a solicitação...");
						},
						success: function (msg) {
							$("#divForm").html("");
							$("#mensagem").html("");
							$.mostraMensagem.text("Exclusao efetuada com sucesso");
							carregaTabela();
						},
						error: function (msg) {
							$("#mensagem").html("");
							$.mostraMensagem("erro");
						}
					});
				});
			};

			$.editar = function (cpf) {
				$.ajax({

					url: "http://localhost:8282/cadastro/ServletModificarFuncionario",
					type: 'get',
					data: {
						id: cpf
					},
					beforeSend: function () {
						$("#mensagem").text("Analisando a solicitação...");
					},
					success: function (msg) {
						$("#divForm").html("");
						$("#mensagem").text(msg);
						$.mostraMensagem.modal('show');
						carregaTabela();
					},
					error: function (msg) {
						$("#mensagem").html("");
						$("#msgModal").text(msg);
						$('#modalMensagem').modal('show');
					}
				});
			};

			$.mostraForm = function () {

				$("#divForm").html(preparaForm());
				$("#mensagem").html("")
			}

			$.salvar = function () {

				let cpf = $("#cpf").val();
				let nome = $("#nome").val();
				nome = nome.toUpperCase();
				let nascimento = $("#nascimento").val();
				let salario = $("#salario").val();
				let departamento = $("#departamento").val();
				let cargo = $("#cargo").val();

				function validaCPF(dados) {
					var i;
					s = dados;
					var dados = s.substr(0, 9);
					var dv = s.substr(9, 2);
					var d1 = 0;
					var v = false;

					for (i = 0; i < 9; i++) {
						d1 += dados.charAt(i) * (10 - i);
					}
					if (d1 == 0) {
						$.mostraMensagem("Atenção! O Cpf deve ser Digitado");
						v = true;
						return false;
					}
					d1 = 11 - (d1 % 11);
					if (d1 > 9) d1 = 0;
					if (dv.charAt(0) != d1) {
						$.mostraMensagem("CPF Inválido, não use pontos ou traços, use apenas os 11 números");
						v = true;
						return false;
					}

					d1 *= 2;
					for (i = 0; i < 9; i++) {
						d1 += c.charAt(i) * (11 - i);
					}
					d1 = 11 - (d1 % 11);
					if (d1 > 9) d1 = 0;
					if (dv.charAt(1) != d1) {
						alert("CPF Inválido, não use pontos ou traços, use apenas os 11 números");
						v = true;
						return false;
					}
				}
				validaCPF(cpf);
			
				
				function validaDecimal(data) {
					var decimal = /^[-+]?[0-9]+\.[0-9]+$/;
					if (data.value.match(decimal)) {
						return true;
					} else {
						$.mostraMensagem('O salário base não pode estar vazio e deve conter números com 2 casas decimais separadas por ponto')
						return false;
					}
				} 
				validaDecimal(salario);
			

				if (nome.length == 0 || nome == "") {
					$.mostraMensagem("nome deve ser informado!");
				} else {
					$.enviaDadosCadastro(cpf, nome, nascimento, salario, departamento, cargo);
				}
			}
			
			
			function validaData(data) {
				var date = data;
				var ardt = new Array;
				var ExpReg = new RegExp("(0[1-9]|[12][0-9]|3[01])/(0[1-9]|1[012])/[12][0-9]{3}");
				ardt = date.split("/");
				erro = false;
				if (date.search(ExpReg) == -1) {
					erro = true;
				} else if (((ardt[1] == 4) || (ardt[1] == 6) || (ardt[1] == 9) || (ardt[1] == 11)) && (ardt[0] > 30))
					erro = true;
				else if (ardt[1] == 2) {
					if ((ardt[0] > 28) && ((ardt[2] % 4) != 0))
						erro = true;
					if ((ardt[0] > 29) && ((ardt[2] % 4) == 0))
						erro = true;
				}
				if (erro) {
					$.mostraMensagem(data + "A data de nascimento precisa ser inserida, utilize o formato MM/DD/AAAA");
					return false;
				}
				return true;
			}
			validaData(nascimento);
			

			$.enviarDadosCadastro = function (cpf, nome, nascimento, salario, departamento, cargo) {
				$.ajax({
					url: "urlDoServlet",
					type: 'get',
					data: {
						id: cpf,
						nome: nome,
						nascimento: nascimento,
						salario: salario,
						cargo: cargo,
						departamento: departamento
					},

					beforeSend: function () {
						$("#mensagem").html("Enviando / salvando dados...");
					},
					success: function (msg) {
						$("#mensagem").html("");
						$.mostraMensagem(msg.mensagem);
						carregaTabela();
					},
					error: function (msg) {
						$("#mensagem").html("");
						$.mostraMensagem(msg.mensagem);
					}
				});
			};

			$.populaForm = function (cpf) {

				$.ajax({

					url: "http://localhost:8282/cadastro/ServletAll",
					type: 'get',
					data: {
						id: cpf,
					},

					beforeSend: function () {
						$("#mensagem").html("Consultando dados...");
					},
					success: function (msg) {
						$("#mensagem").html("");
						if (msg.id != 0) {
							
							$("#cpf").val(msg.id);
							$("#nome").val(msg.nome);
							$("#nascimento").val(msg.nascimento);
							$("#salario").val(msg.salariounit);
							$("cargo").val(msg.cargo);
							$("departamento").val(msg.departamento);
						}
					},
					error: function (msg) {
						$("#mensagem").html("");
						$.mostraMensagem(msg[0].mensagem);
					}
				});
			};



			$.limpar = function () {
				$("#divForm").html("");
			}

			$.mostraMensagem = function (msg) {
				$("#msgModal").text(msg);
				$("modalMensagem").modal();
			}
		});


	</script>

	<!-- Bootstrap Scripts  -->
	<script
		src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
		integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
		crossorigin="anonymous"></script>
	<script
		src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
		integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
		crossorigin="anonymous"></script>
</body>

</html>